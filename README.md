# Сервис управления подписками

REST-сервис для агрегации данных об онлайн-подписках пользователей.

## Описание проекта

Сервис предоставляет API для управления подписками пользователей и расчета их стоимости за выбранный период времени. Реализованы все необходимые CRUD-операции, а также специализированный эндпоинт для подсчета суммарной стоимости подписок с возможностью фильтрации по различным параметрам.

## Технический стек

- **Язык программирования**: Go 1.21
- **Веб-фреймворк**: Chi Router
- **База данных**: PostgreSQL
- **Миграции**: migrate/migrate
- **Валидация**: validator/v10
- **Логирование**: zerolog
- **Конфигурация**: viper, godotenv
- **Документация API**: Swagger
- **Контейнеризация**: Docker, Docker Compose

## Структура проекта

Проект организован согласно принципам чистой архитектуры:

```
subscription-service/
├── api/                    # API документация
│   └── swagger.yaml        # Swagger спецификация в формате YAML
├── cmd/                    # Точки входа в приложение
│   └── app/                # Основное приложение
│       └── main.go         # Главный файл приложения
├── configs/                # Конфигурационные файлы
│   ├── config.go           # Структуры конфигурации
│   └── config.yaml         # Файл конфигурации YAML
├── docs/                   # Документация API
│   └── swagger.json        # Swagger спецификация в формате JSON
├── internal/               # Внутренний код приложения
│   ├── delivery/           # Уровень доставки (HTTP, gRPC и т.д.)
│   │   └── http/           # HTTP обработчики
│   │       ├── handler/    # Обработчики запросов
│   │       ├── middleware/ # Промежуточные обработчики
│   │       └── router.go   # Маршрутизация
│   ├── domain/             # Бизнес-модели и интерфейсы
│   │   └── subscription/   # Домен подписок
│   ├── repository/         # Реализация репозиториев
│   │   └── postgresql/     # Реализация для PostgreSQL
│   └── usecase/            # Бизнес-логика
├── migrations/             # Миграции базы данных
├── scripts/                # Вспомогательные скрипты
│   ├── seed_docker.go      # Скрипт для заполнения БД тестовыми данными
│   └── watch_logs.ps1      # Скрипт для отслеживания логов
├── .env                    # Переменные окружения
├── docker-compose.yaml     # Конфигурация Docker Compose
├── Dockerfile              # Dockerfile для сборки приложения
├── Dockerfile.seed         # Dockerfile для заполнения БД
├── go.mod                  # Go модули
└── go.sum                  # Хеши зависимостей
```

## Запуск проекта

### Предварительные требования

- Docker и Docker Compose
- Go 1.21 (опционально, для локальной разработки)

### Запуск с помощью Docker Compose

1. Клонируйте репозиторий:
```bash
git clone https://github.com/your-username/subscription-service.git
cd subscription-service
```

2. Подготовьте переменные окружения (при необходимости измените значения по умолчанию):
```bash
cp .env.example .env
```

3. Запустите приложение с помощью Docker Compose:
```bash
docker-compose up -d
```

Это запустит:
- PostgreSQL базу данных
- Сервис миграций для инициализации базы данных
- Основной сервис подписок
- Сервис для заполнения базы данных тестовыми данными

Приложение будет доступно по адресу: http://localhost:8080

### Локальный запуск (для разработки)

1. Установите зависимости:
```bash
go mod download
```

2. Подготовьте переменные окружения (при необходимости измените значения по умолчанию):
```bash
cp .env.example .env
```

3. Запустите PostgreSQL (можно использовать Docker):
```bash
docker-compose up -d postgres
```

4. Примените миграции:
```bash
docker-compose up migrate
```

5. Запустите приложение:
```bash
go run cmd/app/main.go
```

### Пример файла .env

В корне репозитория присутствует файл `.env.example` со всеми необходимыми переменными окружения. Для начала работы скопируйте его в `.env` и при необходимости скорректируйте значения.

```bash
cp .env.example .env
# отредактируйте файл .env при необходимости
```

## Мониторинг логов

Для просмотра логов сервиса в реальном времени можно использовать несколько способов:

### Через Docker Compose

```bash
docker-compose logs -f subscription-service
```

### Через Docker CLI

```bash
docker logs -f subscription-service
```

### С помощью PowerShell скрипта

В проекте есть готовый скрипт для просмотра логов:

```powershell
.\scripts\watch_logs.ps1
```

Скрипт принимает следующие параметры:
- `-Service` - имя сервиса (по умолчанию "subscription-service")
- `-Follow` - следить за логами в реальном времени (по умолчанию true)
- `-Lines` - количество последних строк для отображения (по умолчанию 100)

Примеры использования:
```powershell
# Просмотр логов сервиса подписок в реальном времени
.\scripts\watch_logs.ps1

# Просмотр последних 50 строк логов базы данных
.\scripts\watch_logs.ps1 -Service postgres -Lines 50 -Follow $false
```

## API Документация

Swagger документация доступна по адресу: http://localhost:8080/swagger/index.html

### Основные эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| GET | /api/v1/subscriptions | Получить список всех подписок |
| POST | /api/v1/subscriptions | Создать новую подписку |
| GET | /api/v1/subscriptions/{id} | Получить подписку по ID |
| PUT | /api/v1/subscriptions/{id} | Обновить подписку |
| DELETE | /api/v1/subscriptions/{id} | Удалить подписку |
| GET | /api/v1/subscriptions/calculate-cost | Рассчитать суммарную стоимость подписок |

### Примеры запросов

#### Создание подписки

```bash
curl -X POST -H "Content-Type: application/json" -d '{
  "service_name": "Yandex Plus",
  "price": 400,
  "user_id": "60601fee-2bf1-4721-ae6f-7636e79a0cba",
  "start_date": "07-2025"
}' http://localhost:8080/api/v1/subscriptions
```

#### Получение списка подписок

```bash
curl -X GET http://localhost:8080/api/v1/subscriptions
```

#### Расчет стоимости подписок

```bash
# Расчет стоимости всех подписок пользователя
curl -X GET "http://localhost:8080/api/v1/subscriptions/calculate-cost?user_id=60601fee-2bf1-4721-ae6f-7636e79a0cba&start_period=01-2024&end_period=12-2024"

# Расчет стоимости подписок определенного сервиса
curl -X GET "http://localhost:8080/api/v1/subscriptions/calculate-cost?service_name=Netflix&start_period=01-2024&end_period=12-2024"
```

## Конфигурация

Конфигурация приложения может быть задана через:

1. Файл конфигурации YAML (`configs/config.yaml`)
2. Переменные окружения
3. Файл `.env`

### Основные параметры конфигурации

| Параметр | Переменная окружения | Описание |
|----------|----------------------|----------|
| Хост БД | DATABASE_HOST | Хост базы данных PostgreSQL |
| Порт БД | DATABASE_PORT | Порт базы данных PostgreSQL |
| Имя пользователя БД | DATABASE_USER | Имя пользователя для подключения к БД |
| Пароль БД | DATABASE_PASSWORD | Пароль для подключения к БД |
| Имя БД | DATABASE_DBNAME | Имя базы данных |
| Порт сервера | SERVER_PORT | Порт, на котором запускается HTTP-сервер |
| Уровень логирования | LOGGER_LEVEL | Уровень логирования (debug, info, warn, error) |
| Формат логирования | LOGGER_FORMAT | Формат логирования (json, console) |

## Устранение проблем

### Ошибки подключения к базе данных

При первом запуске сервиса через Docker Compose могут возникать ошибки подключения к базе данных, так как PostgreSQL может не успеть полностью запуститься. Это нормальное поведение, сервис автоматически повторяет попытки подключения.

### Проблемы с Swagger документацией

Если Swagger документация не загружается, убедитесь, что:
1. Файл `docs/swagger.json` существует и содержит корректный JSON
2. Сервер правильно настроен для обслуживания статических файлов

## Лицензия

MIT 